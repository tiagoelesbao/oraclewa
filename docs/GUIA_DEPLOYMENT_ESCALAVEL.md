# üöÄ GUIA DE DEPLOYMENT ESCAL√ÅVEL - OracleWA SaaS v3.0

## üéØ OVERVIEW

Este guia detalha como fazer deploy e configurar novos clientes no **Sistema OracleWA SaaS v3.0 Escal√°vel**, que suporta clientes ilimitados com isolamento total.

---

## üìã PR√â-REQUISITOS

### ‚úÖ **INFRAESTRUTURA ATUAL**
- üñ•Ô∏è **Hetzner VPS:** 128.140.7.154 (Evolution API v2.3.1)
- üöÇ **Railway App:** oraclewa-imperio-production
- üì± **Inst√¢ncias ativas:** imperio_main + broadcast-imperio-*
- üîê **API Key:** Imperio2024@EvolutionSecure

### üõ†Ô∏è **FERRAMENTAS NECESS√ÅRIAS**
```bash
# SSH Access
ssh root@128.140.7.154

# Git repo
https://github.com/tiagoelesbao/oraclewa

# Railway CLI (opcional)
npm install -g @railway/cli
```

---

## üÜï ADICIONAR NOVO CLIENTE

### 1Ô∏è‚É£ **CRIAR ESTRUTURA DO CLIENTE**

**Estrutura necess√°ria:**
```bash
mkdir -p clients/{novo_cliente}/{data/broadcast,templates/messages,templates/variations}
```

**Exemplo para cliente "loja_xyz":**
```bash
clients/loja_xyz/
‚îú‚îÄ‚îÄ config.json                    # Configura√ß√£o principal
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îî‚îÄ‚îÄ broadcast/                 # CSVs para broadcast
‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îú‚îÄ‚îÄ messages/                  # Templates .hbs
‚îÇ   ‚îî‚îÄ‚îÄ variations/                # Varia√ß√µes anti-spam
```

### 2Ô∏è‚É£ **CONFIGURAR CLIENT CONFIG.JSON**

**Criar:** `/clients/loja_xyz/config.json`
```json
{
  "id": "loja_xyz",
  "name": "Loja XYZ E-commerce",
  "description": "Sistema de recupera√ß√£o para Loja XYZ",
  "status": "active",
  "provider": "evolution-baileys",
  "services": ["webhooks", "broadcast"],
  
  "features": {
    "buttons": true,
    "media": true,
    "typing": true,
    "presence": true
  },
  
  "limits": {
    "messagesPerDay": 3000,
    "messagesPerHour": 300,
    "instances": 3
  },
  
  "webhooks": {
    "orderExpired": {
      "enabled": true,
      "url": "https://oraclewa-imperio-production.up.railway.app/webhook/loja_xyz/order_expired",
      "template": "order_expired"
    },
    "orderPaid": {
      "enabled": true,
      "url": "https://oraclewa-imperio-production.up.railway.app/webhook/loja_xyz/order_paid",
      "template": "order_paid"
    }
  },
  
  "broadcast": {
    "enabled": true,
    "instances": [
      "broadcast-loja_xyz-1",
      "broadcast-loja_xyz-2"  
    ],
    "antibanStrategy": "advanced",
    "delays": {
      "min": 90000,
      "max": 150000
    }
  },
  
  "instances": {
    "loja_xyz_main": {
      "type": "recovery",
      "provider": "evolution-baileys",
      "status": "pending",
      "description": "Inst√¢ncia principal webhooks"
    },
    "broadcast-loja_xyz-1": {
      "type": "broadcast",
      "provider": "evolution-baileys", 
      "status": "pending",
      "description": "Broadcast 1/2"
    }
  },
  
  "webhookConfig": {
    "payloadTransformers": {
      "order_expired": {
        "userPhone": "data.customer.phone",
        "userName": "data.customer.name",
        "productTitle": "data.product.name",
        "orderTotal": "data.total"
      }
    }
  },
  
  "infrastructure": {
    "servers": {
      "hetzner": {
        "ip": "128.140.7.154",
        "port": 8080
      }
    }
  }
}
```

### 3Ô∏è‚É£ **CRIAR TEMPLATES PERSONALIZADOS**

**Template Order Expired:**
`/clients/loja_xyz/templates/messages/loja_xyz_order_expired.hbs`
```handlebars
üõçÔ∏è *Ol√° {{customerName}}!*

Notamos que voc√™ n√£o finalizou sua compra na *Loja XYZ*:

üì¶ *{{productName}}*
üí∞ *Total: R$ {{totalValue}}*

‚è∞ *Sua reserva expira em breve!*

Finalize agora com desconto especial:
üéØ *5% OFF* usando o c√≥digo: *VOLTA5*

{{finalizeButton}}
```

**Varia√ß√µes Anti-Spam:**
`/clients/loja_xyz/templates/variations/loja_xyz-order-expired-variations.js`
```javascript
module.exports = {
  greetings: [
    "üõçÔ∏è Ol√° {{customerName}}!",
    "üëã Oi {{customerName}}!",
    "üåü E a√≠ {{customerName}}!"
  ],
  
  urgency: [
    "‚è∞ Sua reserva expira em breve!",
    "üö® √öltimas unidades dispon√≠veis!",
    "‚è≥ Oferta v√°lida por tempo limitado!"
  ],
  
  discounts: [
    "üéØ 5% OFF com VOLTA5",
    "üí• Desconto especial te esperando",
    "üî• Oferta exclusiva para voc√™"
  ]
};
```

### 4Ô∏è‚É£ **AUTO-DISCOVERY DO SISTEMA**

O sistema **detecta automaticamente** novos clientes:

```javascript
// ClientManager auto-carrega /clients/loja_xyz/
async loadAllClients() {
  const clientDirs = await fs.readdir('/clients/', { withFileTypes: true });
  // Sistema detecta 'loja_xyz' automaticamente
}
```

**Verificar se foi carregado:**
```bash
# Via API Health Check
curl https://oraclewa-imperio-production.up.railway.app/health

# Response deve incluir:
{
  "system": {
    "totalClients": 2,
    "loadedConfigs": ["imperio", "loja_xyz"]
  }
}
```

### 5Ô∏è‚É£ **CRIAR INST√ÇNCIAS HETZNER**

**Via API Management:**
```bash
# Criar todas inst√¢ncias do cliente
curl -X POST "https://oraclewa-imperio-production.up.railway.app/api/management/hetzner/instances/loja_xyz/create"

# Verificar cria√ß√£o
curl "https://oraclewa-imperio-production.up.railway.app/api/management/hetzner/instances"
```

**Ou diretamente no Hetzner:**
```bash
ssh root@128.140.7.154

# Usar script escal√°vel (se dispon√≠vel)
./evo-instances create loja_xyz 2

# Ou criar manualmente via Evolution API
curl -X POST "http://localhost:8080/instance/create" \
  -H "apikey: Imperio2024@EvolutionSecure" \
  -H "Content-Type: application/json" \
  -d '{
    "instanceName": "loja_xyz_main",
    "token": "loja_xyz_main_token"
  }'
```

### 6Ô∏è‚É£ **CONECTAR INST√ÇNCIAS WHATSAPP**

**Obter QR Codes:**
```bash
# Via API
curl "https://oraclewa-imperio-production.up.railway.app/api/management/hetzner/instances/loja_xyz_main/qrcode"

# Ou diretamente no Hetzner  
curl "http://128.140.7.154:8080/instance/connect/loja_xyz_main" \
  -H "apikey: Imperio2024@EvolutionSecure"
```

**Conectar WhatsApp:**
1. Abrir WhatsApp Web
2. Escanear QR Code
3. Aguardar confirma√ß√£o conex√£o

### 7Ô∏è‚É£ **TESTAR SISTEMA COMPLETO**

**Teste Webhook:**
```bash
# Debug endpoint (n√£o envia WhatsApp)
curl -X POST "https://oraclewa-imperio-production.up.railway.app/api/debug/webhook/loja_xyz/order_expired" \
  -H "Content-Type: application/json" \
  -d '{
    "data": {
      "customer": {
        "name": "Jo√£o Silva",
        "phone": "5511999999999"
      },
      "product": {
        "name": "Produto Teste"
      },
      "total": 99.90
    }
  }'
```

**Teste Real:**
```bash
curl -X POST "https://oraclewa-imperio-production.up.railway.app/webhook/loja_xyz/order_expired" \
  -H "Content-Type: application/json" \
  -d '{
    "data": {
      "customer": {
        "name": "Jo√£o Teste",
        "phone": "SEU_NUMERO_TESTE"
      }
    }
  }'
```

---

## üîß CONFIGURA√á√ÉO AVAN√áADA

### üõ°Ô∏è **ANTI-BAN POR CLIENTE**

**Configurar delays espec√≠ficos:**
```json
{
  "broadcast": {
    "antibanStrategy": "conservative", // conservative, balanced, aggressive
    "delays": {
      "min": 120000,  // 2 minutos m√≠nimo
      "max": 300000   // 5 minutos m√°ximo
    },
    "warmup": {
      "enabled": true,
      "messagesPerDay": 30,
      "daysRequired": 10
    }
  }
}
```

### üì± **M√öLTIPLAS INST√ÇNCIAS**

**Load balancing autom√°tico:**
```json
{
  "broadcast": {
    "instances": [
      "broadcast-loja_xyz-1",
      "broadcast-loja_xyz-2",
      "broadcast-loja_xyz-3"
    ],
    "loadBalancing": {
      "strategy": "round-robin",
      "maxPerInstance": 300,
      "dailyLimit": 900
    }
  }
}
```

### üîÑ **WEBHOOK PAYLOAD CUSTOMIZADO**

**Transformadores espec√≠ficos:**
```json
{
  "webhookConfig": {
    "payloadTransformers": {
      "order_expired": {
        "userPhone": "customer.telefone",        // Campo customizado
        "userName": "customer.nome_completo",    // Campo customizado  
        "productTitle": "item.titulo",           // Campo customizado
        "orderTotal": "pedido.valor_total"       // Campo customizado
      }
    },
    "validation": {
      "requiredFields": ["userPhone", "userName"],
      "phoneFormat": "international"  // brazilian, international
    }
  }
}
```

---

## üìä MONITORAMENTO E GEST√ÉO

### üìà **APIS DE MANAGEMENT**

**Status do Cliente:**
```bash
curl "https://oraclewa-imperio-production.up.railway.app/api/management/clients/loja_xyz"
```

**Listar Arquivos Broadcast:**
```bash  
curl "https://oraclewa-imperio-production.up.railway.app/api/management/clients/loja_xyz/broadcast/files"
```

**Dashboard Geral:**
```bash
curl "https://oraclewa-imperio-production.up.railway.app/api/management/dashboard"
```

### üîÑ **RELOAD CONFIGURA√á√ïES**

**Recarregar cliente espec√≠fico:**
```bash
curl -X POST "https://oraclewa-imperio-production.up.railway.app/api/management/reload/clients"
```

**Recarregar templates:**
```bash
curl -X POST "https://oraclewa-imperio-production.up.railway.app/api/management/reload/templates"
```

---

## üö® TROUBLESHOOTING

### ‚ùå **CLIENTE N√ÉO CARREGOU**

**Verificar estrutura:**
```bash
# Estrutura deve existir:
clients/novo_cliente/config.json ‚úÖ
clients/novo_cliente/data/ ‚úÖ
clients/novo_cliente/templates/ ‚úÖ
```

**Verificar logs Railway:**
```bash
# Procurar por:
"‚úÖ Client loaded: novo_cliente"
# ou  
"‚ùå Failed to load client: novo_cliente"
```

### ‚ùå **WEBHOOK N√ÉO FUNCIONA**

**1. Verificar URL:**
```bash
# URL deve seguir padr√£o:
https://oraclewa-imperio-production.up.railway.app/webhook/{clientId}/{type}
```

**2. Testar payload:**
```bash
curl -X POST "{URL}" -H "Content-Type: application/json" -d '{
  "data": {"customer": {"name": "Teste", "phone": "11999999999"}}
}'
```

**3. Verificar logs:**
```bash
# Logs Railway devem mostrar:
"üì• Processing webhook: novo_cliente/order_expired"
"‚úÖ Webhook processed successfully"
```

### ‚ùå **INST√ÇNCIA N√ÉO CONECTA**

**Verificar status:**
```bash
curl "http://128.140.7.154:8080/instance/fetchInstances" \
  -H "apikey: Imperio2024@EvolutionSecure" | grep "novo_cliente"
```

**Reconectar:**
```bash
curl "http://128.140.7.154:8080/instance/connect/novo_cliente_main" \
  -H "apikey: Imperio2024@EvolutionSecure"
```

---

## ‚úÖ CHECKLIST DE DEPLOY

### üìã **PR√â-DEPLOY**
- [ ] Estrutura `/clients/{cliente}/` criada
- [ ] `config.json` configurado e validado
- [ ] Templates personalizados criados  
- [ ] Varia√ß√µes anti-spam preparadas
- [ ] URLs webhook definidas

### üìã **DEPLOY**
- [ ] Cliente auto-descoberto pelo sistema
- [ ] Inst√¢ncias Hetzner criadas
- [ ] QR Codes gerados e conectados
- [ ] Webhooks testados (debug + real)
- [ ] Templates carregados corretamente

### üìã **P√ìS-DEPLOY**
- [ ] Monitoramento configurado
- [ ] Logs funcionando
- [ ] Health check OK
- [ ] Backup configura√ß√µes
- [ ] Documenta√ß√£o cliente atualizada

---

## üéØ EXEMPLOS REAIS

### üõí **E-COMMERCE PADR√ÉO**

**Config para loja online t√≠pica:**
```json
{
  "id": "minha_loja",
  "name": "Minha Loja Online",
  "limits": {
    "messagesPerDay": 2000,
    "messagesPerHour": 200
  },
  "webhookConfig": {
    "payloadTransformers": {
      "order_expired": {
        "userPhone": "billing.phone",
        "userName": "billing.first_name",
        "productTitle": "line_items[0].name",
        "orderTotal": "total"
      }
    }
  }
}
```

### üè¢ **EMPRESA SERVI√áOS**

**Config para presta√ß√£o de servi√ßos:**
```json
{
  "id": "consultoria_xyz",  
  "name": "Consultoria XYZ",
  "limits": {
    "messagesPerDay": 500,
    "messagesPerHour": 50
  },
  "broadcast": {
    "antibanStrategy": "conservative",
    "delays": {
      "min": 180000,  // 3 minutos
      "max": 600000   // 10 minutos
    }
  }
}
```

### üéØ **MARKETING DIGITAL**

**Config para ag√™ncia:**
```json
{
  "id": "agencia_marketing",
  "name": "Ag√™ncia Marketing Digital", 
  "limits": {
    "messagesPerDay": 5000,
    "messagesPerHour": 500
  },
  "broadcast": {
    "instances": [
      "broadcast-agencia_marketing-1",
      "broadcast-agencia_marketing-2", 
      "broadcast-agencia_marketing-3",
      "broadcast-agencia_marketing-4"
    ],
    "antibanStrategy": "aggressive"
  }
}
```

---

## üöÄ CONCLUS√ÉO

O **Sistema de Deploy Escal√°vel** permite:

### ‚úÖ **VANTAGENS**
- üÜï **Novos clientes em <30 minutos**
- üîÑ **Zero downtime** - Sem interrup√ß√£o outros clientes  
- üõ°Ô∏è **Isolamento total** - Configura√ß√µes independentes
- üìä **Monitoramento individual** - M√©tricas por cliente
- ‚ö° **Auto-scaling** - Sistema cresce automaticamente

### üéØ **PR√ìXIMOS PASSOS**
1. Configurar primeiro novo cliente de teste
2. Validar todo fluxo de deploy
3. Criar automa√ß√£o adicional se necess√°rio
4. Documentar procedimentos espec√≠ficos por cliente
5. Estabelecer processo de onboarding

---

*üìÖ Guia criado: 11/08/2025*  
*‚úçÔ∏è Autor: Claude Code*  
*üöÄ Vers√£o: Sistema Escal√°vel v3.0*  
*üéØ Status: Pronto para deploy ilimitado de clientes*